<!DOCTYPE html>
<html lang="zh-Hans">
    <head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">

    

    <!-- 渲染优化 -->
    <meta name="renderer" content="webkit">
    <meta name="force-rendering" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="HandheldFriendly" content="True">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <!--icon-->

    
    
    
    
    


    <!-- meta -->


<title>Core Data 数据版本/迁移 | { }</title>


    <meta name="keywords" content="iOS, CoreData, 技术/iOS/大前端">




    <!-- OpenGraph -->
 
    <meta name="description" content="CoreData基本入坑指南">
<meta name="keywords" content="iOS,CoreData">
<meta property="og:type" content="article">
<meta property="og:title" content="Core Data 数据版本&#x2F;迁移">
<meta property="og:url" content="http://blog.knpc21.com/ios/core-data-versioning/index.html">
<meta property="og:site_name" content="{ }">
<meta property="og:description" content="CoreData基本入坑指南">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2016-08-07T16:08:33.000Z">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Core Data 数据版本&#x2F;迁移">
<meta name="twitter:description" content="CoreData基本入坑指南">


    <link rel="stylesheet" href="/css/style/main.css"> 

    
    
        <link rel="stylesheet" id="hl-default-theme" href="/css/highlight/default.css" media="none" onload="this.media='all'">
        
    

    
    

    

     

    <!-- custom head -->

</head>

    <body>
        <div id="app">
            <header class="header">
    <div class="header__left">
        <a href="/" class="button">
            <span class="logo__text">余的技术博客</span>
        </a>
    </div>
    <div class="header__right">
        
            <div class="navbar__menus">
                
                    <a href="/" class="navbar-menu button">首页</a>
                
                    <a href="/archives/" class="navbar-menu button">归档</a>
                
                    <a href="/tags/" class="navbar-menu button">标签</a>
                
                    <a href="/about" class="navbar-menu button">关于</a>
                
            </div>
        
        
        
    <a href="/search/" id="btn-search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" width="24" height="24" fill="currentColor" stroke="currentColor" stroke-width="32"><path d="M192 448c0-141.152 114.848-256 256-256s256 114.848 256 256-114.848 256-256 256-256-114.848-256-256z m710.624 409.376l-206.88-206.88A318.784 318.784 0 0 0 768 448c0-176.736-143.264-320-320-320S128 271.264 128 448s143.264 320 320 320a318.784 318.784 0 0 0 202.496-72.256l206.88 206.88 45.248-45.248z"></path></svg>
    </a>


        
        

        
            <a class="dropdown-icon button" id="btn-dropdown" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width='24' height='24' fill="none" stroke="currentColor" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round"><path fill="currentColor" d="M3.314,4.8h13.372c0.41,0,0.743-0.333,0.743-0.743c0-0.41-0.333-0.743-0.743-0.743H3.314c-0.41,0-0.743,0.333-0.743,0.743C2.571,4.467,2.904,4.8,3.314,4.8z M16.686,15.2H3.314c-0.41,0-0.743,0.333-0.743,0.743s0.333,0.743,0.743,0.743h13.372c0.41,0,0.743-0.333,0.743-0.743S17.096,15.2,16.686,15.2z M16.686,9.257H3.314c-0.41,0-0.743,0.333-0.743,0.743s0.333,0.743,0.743,0.743h13.372c0.41,0,0.743-0.333,0.743-0.743S17.096,9.257,16.686,9.257z"></path></svg></a>
            <div class="dropdown-menus" id="dropdown-menus">
                
                    <a href="/" class="dropdown-menu button">首页</a>
                
                    <a href="/archives/" class="dropdown-menu button">归档</a>
                
                    <a href="/tags/" class="dropdown-menu button">标签</a>
                
                    <a href="/about" class="dropdown-menu button">关于</a>
                
            </div>
        
    </div>
</header>


            <main class="main">
    

<div class="post-title">
    <h1 class="post-title__text">
        Core Data 数据版本/迁移
    </h1>
    <div class="post-title__meta">
        <a href="/archives/2016/08/" class="post-meta__date button">2016-08-08</a>
        
    <span class="separate-dot"></span><a href="/categories/iOS/" class="button">iOS</a>

 
        
    
    


 

 
    </div>
</div>



<article class="post content-card">
    <div class="post__header"></div>
    <div class="post__content">
        <p>CoreData基本入坑指南</p>
<a id="more"></a>
<h4 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h4><p>开发中使用Core Data的确是要配置挺多内容的，首先要配置Model-Context-Coordinator-Store、配置Store的数据迁移策略(以及可能的数据迁移)，还要处理多线程读写的问题。想用CoreData但又不想写太多这样业务无关代码时，MagicalRecord算是一个不错的选择。但像我这样用上了Core Data但没用（或者不想用）MagicalRecord之类的工具库时，做数据版本迁移是迟早的事情嘛。</p>
<p>使用Core Data，基本问题涉及数据模型定义、Model-Context-Coordinator-Store配置、CURD操作，还有现在要说的数据版本/迁移，以后要说的多线程问题。最近刚好处理版本迁移问题，简单记录下，基本配置以及多线程等问题迟些再补充。</p>
<p>关于Core Data以及它的数据版本迁移，可以先看下以下资料：</p>
<ul>
<li><a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/CoreData/index.html#//apple_ref/doc/uid/TP40001075" title="Core Data Programming Guide" target="_blank" rel="noopener">Core Data Programming Guide</a></li>
<li><a href="https://developer.apple.com/library/ios/documentation/cocoa/conceptual/CoreDataVersioning/Articles/Introduction.html#//apple_ref/doc/uid/TP40004399-CH1-SW1" title="Core Data Migration Programming Guide" target="_blank" rel="noopener">Core Data版本/数据迁移 Programming Guide</a></li>
<li><a href="http://objccn.io/issue-4-7" title="objc.io文章" target="_blank" rel="noopener">自定义Core Data迁移（<strong>objc.io</strong>好文）</a></li>
</ul>
<h4 id="数据模型版本-映射模型"><a href="#数据模型版本-映射模型" class="headerlink" title="数据模型版本/映射模型"></a>数据模型版本/映射模型</h4><h5 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h5><p>Xcode可以直接在模型文件上创建不同版本的模型定义。</p>
<ol>
<li>定义新版本：选中.xcdatamodeld模型文件（其实是文件夹），菜单Editor-&gt;Add Model Version，可选择基于当前特定版本的模型创建新版本的模型定义；创建后，.xcdatamodeld文件夹下增加.xcdatamodel的模型文件（其实也是文件夹）；</li>
<li>指定使用版本：选中.xcdatamodeld模型文件，在Xcode右侧工具栏中，Model Version可以选择模型所使用的版本，选中的版本带有绿色勾选高亮；</li>
</ol>
<p>sublime打开.xcdatamodeld目录可以一窥CoreData的模型文件（都提供给IDE使用）：<br>首先是增加了一个.xccurrentversion的plist版本记录文件，内容很简单，仅是用一个key来表明当前所选的model文件：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">plist</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//Apple//DTD PLIST 1.0//EN"</span> <span class="meta-string">"http://www.apple.com/DTDs/PropertyList-1.0.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plist</span> <span class="attr">version</span>=<span class="string">"1.0"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">key</span>&gt;</span>_XCCurrentVersionName<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">string</span>&gt;</span>XXXModel_v2.xcdatamodel<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plist</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>.xcdatamodel/contents则是模型定义的xml文件（仅作示例）：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">model</span> <span class="attr">userDefinedModelVersionIdentifier</span>=<span class="string">""</span> <span class="attr">type</span>=<span class="string">"com.apple.IDECoreDataModeler.DataModel"</span> <span class="attr">documentVersion</span>=<span class="string">"1.0"</span> <span class="attr">lastSavedToolsVersion</span>=<span class="string">"10171"</span> <span class="attr">systemVersion</span>=<span class="string">"15D21"</span> <span class="attr">minimumToolsVersion</span>=<span class="string">"Xcode 7.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">entity</span> <span class="attr">name</span>=<span class="string">"FDMessage"</span> <span class="attr">representedClassName</span>=<span class="string">"FDMessage"</span> <span class="attr">syncable</span>=<span class="string">"YES"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"clientID"</span> <span class="attr">optional</span>=<span class="string">"YES"</span> <span class="attr">attributeType</span>=<span class="string">"Integer 32"</span> <span class="attr">defaultValueString</span>=<span class="string">"0"</span> <span class="attr">syncable</span>=<span class="string">"YES"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"content"</span> <span class="attr">optional</span>=<span class="string">"YES"</span> <span class="attr">attributeType</span>=<span class="string">"String"</span> <span class="attr">syncable</span>=<span class="string">"YES"</span>/&gt;</span></span><br><span class="line">      	<span class="tag">&lt;<span class="name">relationship</span> <span class="attr">name</span>=<span class="string">"draft"</span> <span class="attr">optional</span>=<span class="string">"YES"</span> <span class="attr">maxCount</span>=<span class="string">"1"</span> <span class="attr">deletionRule</span>=<span class="string">"Nullify"</span> <span class="attr">destinationEntity</span>=<span class="string">"XXXXPostDraft"</span> <span class="attr">inverseName</span>=<span class="string">"game"</span> <span class="attr">inverseEntity</span>=<span class="string">"IMPPostDraft"</span> <span class="attr">syncable</span>=<span class="string">"YES"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">entity</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">elements</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">element</span> <span class="attr">name</span>=<span class="string">"FDMessage"</span> <span class="attr">positionX</span>=<span class="string">"-63"</span> <span class="attr">positionY</span>=<span class="string">"-18"</span> <span class="attr">width</span>=<span class="string">"128"</span> <span class="attr">height</span>=<span class="string">"180"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">elements</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">model</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>内容除了记录编辑器的一些信息，主要还是模型信息，且基本与Xcode上可视化的配置是对应的。</p>
<ul>
<li><code>elements</code>包含模型文件中的实体(Entity)列表，<code>positionX</code>、<code>positionY</code>、<code>width</code>、<code>height</code>暂未去探讨实际意义(可能是跟序列化过程中的数据布局相关)；</li>
<li><code>entity</code>则是每个实体的配置信息，包括普通属性<code>attribute</code>、关系(属性)<code>relationship</code>（当然还有fetched property此处未有）。<code>name</code>是实体名称，<code>representedClassName</code>则是类名（syncable是iCloud相关?）；可以看到Core Data实体名称跟类名是可以独立的，这也是我们项目重构时可以利用的特性（已有开源库）。<ul>
<li><code>attribute</code>属性，包含属性名<code>name</code>、是否可选<code>optional</code>、属性类型<code>attributeType</code>、默认值<code>defaultValueString</code>、syncable未知特性</li>
<li><code>relationship</code>关系，包含关系名<code>name</code>、是否可选<code>optional</code>、<strong>关联数</strong><code>maxCount</code>（一对多|一对一）、<strong>删除规则</strong><code>deleteRule</code>、目标实体<code>destinationEntity</code>、本实体在目标实体中的关系名<code>inverseName</code>、<code>inverseEntity</code>，<code>syncable</code></li>
</ul>
</li>
</ul>
<p>这些模型定义配置文件由Xcode编译后，会在.app目录下生成CoreData运行时使用的模型定义文件（夹）XXXModel.momd。</p>
<p>对于单一版本的模型文件，.momd中包含二进制格式XXXModel.mom模型定义以及一个biplist格式的版本信息文件VersionInfo.plist。对于多版本的模型文件.momd中则对应每个版本的模型定义生成一个.mom，以及.omo文件。你可能会好奇mom文件是什么呀？其实在Xcode5之后，通过 .xcdatamodel &gt; Editor &gt; Import可以完全复原数据模型的定义。omo又是什么呢，其实是当前版本模型定义数据的另一种格式，stackoverflow上已经有回答了：</p>
<blockquote>
<p>At WWDC this year I talked to the Core Data engineers in the labs and they told me that the <code>.omo</code>file is just an optimized version of the <code>.mom</code> file. The <code>.mom</code> file is a binary plist while the <code>.omo</code> is some other sort of format that’s faster to load.</p>
<p>They told me that you could safely remove the <code>.omo</code> file and Core Data would load from the—slightly slower—<code>.mom</code> file instead. They told me that doing so would only result in an additional few milliseconds of load time (which begs the question of why they bothered to optimize it in the first place).  —<a href="http://stackoverflow.com/questions/12136253/whats-core-datas-omo-file-is-it-required" target="_blank" rel="noopener">stackoverflow</a> by Ben Dolman, Jun 9’ 14</p>
</blockquote>
<p>转换一下格式<code>plutil -convert xml1 VersionInfo.plist -o Version.plist</code>可以看到VersionInfo.plist记录的是模型各个版本文件中实体配置的哈希：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">plist</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//Apple//DTD PLIST 1.0//EN"</span> <span class="meta-string">"http://www.apple.com/DTDs/PropertyList-1.0.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plist</span> <span class="attr">version</span>=<span class="string">"1.0"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">key</span>&gt;</span>NSManagedObjectModel_CurrentVersionName<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">string</span>&gt;</span>XXXXModel_v2<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">key</span>&gt;</span>NSManagedObjectModel_VersionHashes<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>XXXXModel<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">key</span>&gt;</span>XXXXPostBar<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">			a6XkvwC0MIm1elA5eYd4uA3FzntU+vPOhevcQSaRZao=</span><br><span class="line">			<span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">key</span>&gt;</span>XXXXPostBarItem<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">			Xn+9Y8VANgNRE9ErKE4Y817NpeG65zjH+9sZC3oN1vc=</span><br><span class="line">			<span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">key</span>&gt;</span>XXXXModel_v2<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">key</span>&gt;</span>XXXXPostBar<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">			10VLx7aAOrS8fdqu9Nb8GYyUpkjJt+Z7J/7ZaiqPYXE=</span><br><span class="line">			<span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">key</span>&gt;</span>XXXXPostBarItem<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">			Xn+9Y8VANgNRE9ErKE4Y817NpeG65zjH+9sZC3oN1vc=</span><br><span class="line">			<span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plist</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以看到在v2版本中实体XXXXPostBar改变了。CoreData将对发生改变的实体、依赖版本间映射关系进行数据迁移。（p.s .xcdatamodel文件Xcode不支持直接delete，可以尝试对.xcdatamodeld先remove reference，手动删除.xcdatamodel，再重新将.xcdatamodel添加到project）</p>
<h5 id="映射模型"><a href="#映射模型" class="headerlink" title="映射模型"></a>映射模型</h5><p>不同版本的数据迁移，需要知道模型版本间的数据关系，Xcode使用.xcmappingmodel来编辑记录这种映射关系。.xcmappingmodel同样是一文件夹，包含xcmapping.xml。.xcmapping.xml内容示例如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" standalone="no"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">database</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"file:///System/Library/DTDs/CoreData.dtd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">database</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">databaseInfo</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>134481920<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">UUID</span>&gt;</span>701B3B37-7743-4E35-8C9C-CA081667974B<span class="tag">&lt;/<span class="name">UUID</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nextObjectID</span>&gt;</span>114<span class="tag">&lt;/<span class="name">nextObjectID</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">metadata</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plist</span> <span class="attr">version</span>=<span class="string">"1.0"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">key</span>&gt;</span>NSPersistenceFrameworkVersion<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">integer</span>&gt;</span>641<span class="tag">&lt;/<span class="name">integer</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">key</span>&gt;</span>NSStoreModelVersionHashes<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">key</span>&gt;</span>XDDevAttributeMapping<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">data</span>&gt;</span>0plcXXRN7XHKl5CcF+fwriFmUpON3ZtcI/AfK748aWc=<span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">key</span>&gt;</span>XDDevEntityMapping<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">data</span>&gt;</span>qeN1Ym3TkWN1G6dU9RfX6Kd2ccEvcDVWHpd3LpLgboI=<span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">key</span>&gt;</span>XDDevMappingModel<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">data</span>&gt;</span>EqtMzvRnVZWkXwBHu4VeVGy8UyoOe+bi67KC79kphlQ=<span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">key</span>&gt;</span>XDDevPropertyMapping<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">data</span>&gt;</span>XN33V44TTGY4JETlMoOB5yyTKxB+u4slvDIinv0rtGA=<span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">key</span>&gt;</span>XDDevRelationshipMapping<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">data</span>&gt;</span>akYY9LhehVA/mCb4ATLWuI9XGLcjpm14wWL1oEBtIcs=<span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">key</span>&gt;</span>NSStoreModelVersionHashesVersion<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">integer</span>&gt;</span>3<span class="tag">&lt;/<span class="name">integer</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">key</span>&gt;</span>NSStoreModelVersionIdentifiers<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">string</span>&gt;</span><span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plist</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">metadata</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">databaseInfo</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">object</span> <span class="attr">type</span>=<span class="string">"XDDEVENTITYMAPPING"</span> <span class="attr">id</span>=<span class="string">"z102"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"sourcename"</span> <span class="attr">type</span>=<span class="string">"string"</span>&gt;</span>IMPRecent<span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"mappingtypename"</span> <span class="attr">type</span>=<span class="string">"string"</span>&gt;</span>Undefined<span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"mappingnumber"</span> <span class="attr">type</span>=<span class="string">"int16"</span>&gt;</span>2<span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"destinationname"</span> <span class="attr">type</span>=<span class="string">"string"</span>&gt;</span>IMPRecent<span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"autogenerateexpression"</span> <span class="attr">type</span>=<span class="string">"bool"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relationship</span> <span class="attr">name</span>=<span class="string">"mappingmodel"</span> <span class="attr">type</span>=<span class="string">"1/1"</span> <span class="attr">destination</span>=<span class="string">"XDDEVMAPPINGMODEL"</span> <span class="attr">idrefs</span>=<span class="string">"z113"</span>&gt;</span><span class="tag">&lt;/<span class="name">relationship</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relationship</span> <span class="attr">name</span>=<span class="string">"attributemappings"</span> <span class="attr">type</span>=<span class="string">"0/0"</span> <span class="attr">destination</span>=<span class="string">"XDDEVATTRIBUTEMAPPING"</span> <span class="attr">idrefs</span>=<span class="string">"z110 z104 z107"</span>&gt;</span><span class="tag">&lt;/<span class="name">relationship</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relationship</span> <span class="attr">name</span>=<span class="string">"relationshipmappings"</span> <span class="attr">type</span>=<span class="string">"0/0"</span> <span class="attr">destination</span>=<span class="string">"XDDEVRELATIONSHIPMAPPING"</span>&gt;</span><span class="tag">&lt;/<span class="name">relationship</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">object</span> <span class="attr">type</span>=<span class="string">"XDDEVATTRIBUTEMAPPING"</span> <span class="attr">id</span>=<span class="string">"z103"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">type</span>=<span class="string">"string"</span>&gt;</span>segments<span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relationship</span> <span class="attr">name</span>=<span class="string">"entitymapping"</span> <span class="attr">type</span>=<span class="string">"1/1"</span> <span class="attr">destination</span>=<span class="string">"XDDEVENTITYMAPPING"</span> <span class="attr">idrefs</span>=<span class="string">"z106"</span>&gt;</span><span class="tag">&lt;/<span class="name">relationship</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">object</span> <span class="attr">type</span>=<span class="string">"XDDEVATTRIBUTEMAPPING"</span> <span class="attr">id</span>=<span class="string">"z104"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">type</span>=<span class="string">"string"</span>&gt;</span>draft<span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relationship</span> <span class="attr">name</span>=<span class="string">"entitymapping"</span> <span class="attr">type</span>=<span class="string">"1/1"</span> <span class="attr">destination</span>=<span class="string">"XDDEVENTITYMAPPING"</span> <span class="attr">idrefs</span>=<span class="string">"z102"</span>&gt;</span><span class="tag">&lt;/<span class="name">relationship</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">object</span> <span class="attr">type</span>=<span class="string">"XDDEVATTRIBUTEMAPPING"</span> <span class="attr">id</span>=<span class="string">"z105"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">type</span>=<span class="string">"string"</span>&gt;</span>nodisturb<span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relationship</span> <span class="attr">name</span>=<span class="string">"entitymapping"</span> <span class="attr">type</span>=<span class="string">"1/1"</span> <span class="attr">destination</span>=<span class="string">"XDDEVENTITYMAPPING"</span> <span class="attr">idrefs</span>=<span class="string">"z114"</span>&gt;</span><span class="tag">&lt;/<span class="name">relationship</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">object</span> <span class="attr">type</span>=<span class="string">"XDDEVENTITYMAPPING"</span> <span class="attr">id</span>=<span class="string">"z106"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"sourcename"</span> <span class="attr">type</span>=<span class="string">"string"</span>&gt;</span>IMPChatSession<span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"mappingtypename"</span> <span class="attr">type</span>=<span class="string">"string"</span>&gt;</span>Undefined<span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"mappingnumber"</span> <span class="attr">type</span>=<span class="string">"int16"</span>&gt;</span>3<span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"destinationname"</span> <span class="attr">type</span>=<span class="string">"string"</span>&gt;</span>IMPChatSession<span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"autogenerateexpression"</span> <span class="attr">type</span>=<span class="string">"bool"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relationship</span> <span class="attr">name</span>=<span class="string">"mappingmodel"</span> <span class="attr">type</span>=<span class="string">"1/1"</span> <span class="attr">destination</span>=<span class="string">"XDDEVMAPPINGMODEL"</span> <span class="attr">idrefs</span>=<span class="string">"z113"</span>&gt;</span><span class="tag">&lt;/<span class="name">relationship</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relationship</span> <span class="attr">name</span>=<span class="string">"attributemappings"</span> <span class="attr">type</span>=<span class="string">"0/0"</span> <span class="attr">destination</span>=<span class="string">"XDDEVATTRIBUTEMAPPING"</span> <span class="attr">idrefs</span>=<span class="string">"z109 z108 z103"</span>&gt;</span><span class="tag">&lt;/<span class="name">relationship</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relationship</span> <span class="attr">name</span>=<span class="string">"relationshipmappings"</span> <span class="attr">type</span>=<span class="string">"0/0"</span> <span class="attr">destination</span>=<span class="string">"XDDEVRELATIONSHIPMAPPING"</span>&gt;</span><span class="tag">&lt;/<span class="name">relationship</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">object</span> <span class="attr">type</span>=<span class="string">"XDDEVATTRIBUTEMAPPING"</span> <span class="attr">id</span>=<span class="string">"z107"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">type</span>=<span class="string">"string"</span>&gt;</span>lastChatTime<span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relationship</span> <span class="attr">name</span>=<span class="string">"entitymapping"</span> <span class="attr">type</span>=<span class="string">"1/1"</span> <span class="attr">destination</span>=<span class="string">"XDDEVENTITYMAPPING"</span> <span class="attr">idrefs</span>=<span class="string">"z102"</span>&gt;</span><span class="tag">&lt;/<span class="name">relationship</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">object</span> <span class="attr">type</span>=<span class="string">"XDDEVATTRIBUTEMAPPING"</span> <span class="attr">id</span>=<span class="string">"z108"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">type</span>=<span class="string">"string"</span>&gt;</span>contactID<span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relationship</span> <span class="attr">name</span>=<span class="string">"entitymapping"</span> <span class="attr">type</span>=<span class="string">"1/1"</span> <span class="attr">destination</span>=<span class="string">"XDDEVENTITYMAPPING"</span> <span class="attr">idrefs</span>=<span class="string">"z106"</span>&gt;</span><span class="tag">&lt;/<span class="name">relationship</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">object</span> <span class="attr">type</span>=<span class="string">"XDDEVATTRIBUTEMAPPING"</span> <span class="attr">id</span>=<span class="string">"z109"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">type</span>=<span class="string">"string"</span>&gt;</span>unreadCount<span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relationship</span> <span class="attr">name</span>=<span class="string">"entitymapping"</span> <span class="attr">type</span>=<span class="string">"1/1"</span> <span class="attr">destination</span>=<span class="string">"XDDEVENTITYMAPPING"</span> <span class="attr">idrefs</span>=<span class="string">"z106"</span>&gt;</span><span class="tag">&lt;/<span class="name">relationship</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">object</span> <span class="attr">type</span>=<span class="string">"XDDEVATTRIBUTEMAPPING"</span> <span class="attr">id</span>=<span class="string">"z110"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">type</span>=<span class="string">"string"</span>&gt;</span>contactID<span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relationship</span> <span class="attr">name</span>=<span class="string">"entitymapping"</span> <span class="attr">type</span>=<span class="string">"1/1"</span> <span class="attr">destination</span>=<span class="string">"XDDEVENTITYMAPPING"</span> <span class="attr">idrefs</span>=<span class="string">"z102"</span>&gt;</span><span class="tag">&lt;/<span class="name">relationship</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">object</span> <span class="attr">type</span>=<span class="string">"XDDEVATTRIBUTEMAPPING"</span> <span class="attr">id</span>=<span class="string">"z111"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">type</span>=<span class="string">"string"</span>&gt;</span>contactID<span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relationship</span> <span class="attr">name</span>=<span class="string">"entitymapping"</span> <span class="attr">type</span>=<span class="string">"1/1"</span> <span class="attr">destination</span>=<span class="string">"XDDEVENTITYMAPPING"</span> <span class="attr">idrefs</span>=<span class="string">"z114"</span>&gt;</span><span class="tag">&lt;/<span class="name">relationship</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">object</span> <span class="attr">type</span>=<span class="string">"XDDEVATTRIBUTEMAPPING"</span> <span class="attr">id</span>=<span class="string">"z112"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">type</span>=<span class="string">"string"</span>&gt;</span>saveInContact<span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relationship</span> <span class="attr">name</span>=<span class="string">"entitymapping"</span> <span class="attr">type</span>=<span class="string">"1/1"</span> <span class="attr">destination</span>=<span class="string">"XDDEVENTITYMAPPING"</span> <span class="attr">idrefs</span>=<span class="string">"z114"</span>&gt;</span><span class="tag">&lt;/<span class="name">relationship</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">object</span> <span class="attr">type</span>=<span class="string">"XDDEVMAPPINGMODEL"</span> <span class="attr">id</span>=<span class="string">"z113"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"sourcemodelpath"</span> <span class="attr">type</span>=<span class="string">"string"</span>&gt;</span>FMDBDemo/Models/IMPlayer.xcdatamodeld/IMPlayer.xcdatamodel<span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"sourcemodeldata"</span> <span class="attr">type</span>=<span class="string">"binary"</span>&gt;</span>YnBsaXN0MDDUAAEAAgADAAQABQAGDssOzFgkdmVyc2lvblgkb2JqZWN0c1kkYXJjaGl2ZXJUJHRv (...)</span><br><span class="line">        <span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"destinationmodelpath"</span> <span class="attr">type</span>=<span class="string">"string"</span>&gt;</span>FMDBDemo/Models/IMPlayer.xcdatamodeld/IMPlayer_v2.xcdatamodel<span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"destinationmodeldata"</span> <span class="attr">type</span>=<span class="string">"binary"</span>&gt;</span>YnBsaXN0MDDUAAEAAgADAAQABQAGDssOzFgkdmVyc2lvblgkb2JqZWN0c1kkYXJjaGl2ZXJUJHRv (...)</span><br><span class="line">        <span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relationship</span> <span class="attr">name</span>=<span class="string">"entitymappings"</span> <span class="attr">type</span>=<span class="string">"0/0"</span> <span class="attr">destination</span>=<span class="string">"XDDEVENTITYMAPPING"</span> <span class="attr">idrefs</span>=<span class="string">"z114 z102 z106"</span>&gt;</span><span class="tag">&lt;/<span class="name">relationship</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">object</span> <span class="attr">type</span>=<span class="string">"XDDEVENTITYMAPPING"</span> <span class="attr">id</span>=<span class="string">"z114"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"sourcename"</span> <span class="attr">type</span>=<span class="string">"string"</span>&gt;</span>IMPChatSetting<span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"mappingtypename"</span> <span class="attr">type</span>=<span class="string">"string"</span>&gt;</span>Undefined<span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"mappingnumber"</span> <span class="attr">type</span>=<span class="string">"int16"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"destinationname"</span> <span class="attr">type</span>=<span class="string">"string"</span>&gt;</span>IMPChatSetting<span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"autogenerateexpression"</span> <span class="attr">type</span>=<span class="string">"bool"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relationship</span> <span class="attr">name</span>=<span class="string">"mappingmodel"</span> <span class="attr">type</span>=<span class="string">"1/1"</span> <span class="attr">destination</span>=<span class="string">"XDDEVMAPPINGMODEL"</span> <span class="attr">idrefs</span>=<span class="string">"z113"</span>&gt;</span><span class="tag">&lt;/<span class="name">relationship</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relationship</span> <span class="attr">name</span>=<span class="string">"attributemappings"</span> <span class="attr">type</span>=<span class="string">"0/0"</span> <span class="attr">destination</span>=<span class="string">"XDDEVATTRIBUTEMAPPING"</span> <span class="attr">idrefs</span>=<span class="string">"z105 z112 z111"</span>&gt;</span><span class="tag">&lt;/<span class="name">relationship</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relationship</span> <span class="attr">name</span>=<span class="string">"relationshipmappings"</span> <span class="attr">type</span>=<span class="string">"0/0"</span> <span class="attr">destination</span>=<span class="string">"XDDEVRELATIONSHIPMAPPING"</span>&gt;</span><span class="tag">&lt;/<span class="name">relationship</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">database</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><code>databaseInfo</code>记录了数据库元信息，metadata中包含了持久化框架版本(CoreData)、存储版本哈希（包括涉及的Attribute、Entity、MappingModel、Property、Relation）；<code>object</code>包含好几种不同<code>type</code>的信息，如<code>XDDEVENTITYMAPPING</code>、<code>XDDEVATTRIBUTEMAPPING</code>、<code>XDDEVMAPPINGMODEL</code>等，<code>XDDEVMAPPINGMODEL</code>包含了映射源模型及目标模型的model文件路径、model二进制数据（大概是为了分离datamodel与mappingmodel；</p>
<p><code>databaseInfo</code>中的meta字段sqlite中<code>SELECT Z_PLIST FROM Z_METADATA;</code>比较类似；可通过以下方法获取元数据：<code>-[[NSPersistentStoreCoordinator metadataForPersistentStoreOfType:nilURL:urlerror:]</code>，读取结果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    NSPersistenceFrameworkVersion = 641;</span><br><span class="line">    NSStoreModelVersionHashes =     &#123;</span><br><span class="line">        IMPChatSession = &lt;1d1f9997 5ad2eb64 ed28853b 255c3384 f4978d43 6b54119f bc37776f 9382a644&gt;;</span><br><span class="line">        IMPChatSetting = &lt;8d414f3c c71afbf6 cf2e7a9e d42e548c 24dfe5ff 8fd299a9 c57881d6 70d2ba2f&gt;;</span><br><span class="line">        IMPRecent = &lt;05593ecc 8e61b083 71b8f5a0 2c97d873 4db29dd6 5a63ffb8 968bf814 c7bf6304&gt;;</span><br><span class="line">    &#125;;</span><br><span class="line">    NSStoreModelVersionHashesVersion = 3;</span><br><span class="line">    NSStoreModelVersionIdentifiers =     (</span><br><span class="line">        &quot;&quot;</span><br><span class="line">    );</span><br><span class="line">    NSStoreType = SQLite;</span><br><span class="line">    NSStoreUUID = &quot;1AAFEF41-289B-4F22-BBD7-E05796B3B651&quot;;</span><br><span class="line">    &quot;_NSAutoVacuumLevel&quot; = 2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>.xcmappingmodel经Xcode编译后在.app目录中生成.cdm文件。</p>
<h4 id="轻量级数据迁移"><a href="#轻量级数据迁移" class="headerlink" title="轻量级数据迁移"></a>轻量级数据迁移</h4><p>当数据模型的改变仅是实体或属性重命名、增删实体属性、属性可选特性更改或定义默认值等改变时(所有支持类型看<a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/CoreDataVersioning/Articles/vmLightweightMigration.html#//apple_ref/doc/uid/TP40004399-CH4-SW2" target="_blank" rel="noopener">这里</a>)，使用轻量级数据迁移即可；NSPersistentStoreCoordinator 会自动推断出mapping model(因为VersionInfo及mom中包含了足够的信息)，实现代码寥寥数行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">NSError *error = nil;</span><br><span class="line">NSURL *storeURL = &lt;#The URL of a persistent store#&gt;;</span><br><span class="line">NSPersistentStoreCoordinator *psc = &lt;#The coordinator#&gt;;</span><br><span class="line">NSDictionary *options = [NSDictionary dictionaryWithObjectsAndKeys:</span><br><span class="line">    [NSNumber numberWithBool:YES], NSMigratePersistentStoresAutomaticallyOption,</span><br><span class="line">    [NSNumber numberWithBool:YES], NSInferMappingModelAutomaticallyOption, nil];</span><br><span class="line"> </span><br><span class="line">BOOL success = [psc addPersistentStoreWithType:&lt;#Store type#&gt;</span><br><span class="line">                    configuration:&lt;#Configuration or nil#&gt; URL:storeURL</span><br><span class="line">                    options:options error:&amp;error];</span><br><span class="line">if (!success) &#123;</span><br><span class="line">    // Handle the error.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>只需要添加持久化存储时添加选项支持自动推断mappingModel进行数据迁移即可。虽然可以手动迁移数据，苹果还是推荐尽可能利用自动推断方式进行迁移：</p>
<blockquote>
<p>A further advantage of using lightweight migration—beyond the fact that you don’t need to create the mapping model yourself—is that if you use an inferred model and you use the SQLite store, then Core Data can perform the migration in situ (solely by issuing SQL statements). This can represent a significant performance benefit as Core Data doesn’t have to load any of your data. Because of this, you are encouraged to use inferred migration where possible, even if the mapping model you might create yourself would be trivial.</p>
</blockquote>
<p>另外，要支持lightwight的方式，Core Data必须要能在运行时找得到源模型及(迁移)目标模型，这个搜索路径默认是<code>[NSBundle allBundles]</code>以及<code>[NSBundle allFrameworks]</code>，模型文件存放在此外的需要使用Migration manager，见<a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/CoreDataVersioning/Articles/vmLightweightMigration.html#//apple_ref/doc/uid/TP40004399-CH4-SW3" target="_blank" rel="noopener">此处</a>说明。</p>
<h4 id="自定义数据迁移"><a href="#自定义数据迁移" class="headerlink" title="自定义数据迁移"></a>自定义数据迁移</h4><p>当模型修改较多导致<code>NSMigrationManager</code>无法推断出mapping model时，Core Data需要我们明确提供mapping model才能完成数据迁移。</p>
<h5 id="创建映射模型（mapping-model）"><a href="#创建映射模型（mapping-model）" class="headerlink" title="创建映射模型（mapping model）"></a>创建映射模型（mapping model）</h5><p>创建mapping model其实很简单，当你新建了model版本后，可以创建一个mapping model的文件，需要你确认指定映射模型的基准模型（也就是上一版本的Model）及目标模型（当前版本的Model）。</p>
<p>需要注意进行渐进式数据迁移，也就是每次模型版本更新后都需要创建一个mapping model。否则如果用户跳跃版本更新，会缺失部分版本之间数据迁移的映射模型，这可能是灾难性的错误；而如果要创建所有不同版本之间的映射关系，O(n^2)的复杂度，这是另一个灾难。</p>
<h5 id="迁移过程"><a href="#迁移过程" class="headerlink" title="迁移过程"></a>迁移过程</h5><p>先看下数据迁移的入口，入参主要是数据库的路径及数据模型：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// 迁移入口</span><br><span class="line">- (void)migrate:(NSError *__autoreleasing *)error &#123;</span><br><span class="line">    __block UIBackgroundTaskIdentifier bgTask;</span><br><span class="line">    bgTask = [[UIApplication sharedApplication] beginBackgroundTaskWithExpirationHandler:^&#123;</span><br><span class="line">        [[UIApplication sharedApplication] endBackgroundTask:bgTask];</span><br><span class="line">        bgTask = UIBackgroundTaskInvalid;</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    CoreDataMigrationManager *migrationManager = [CoreDataMigrationManager new];</span><br><span class="line">    migrationManager.delegate = self;</span><br><span class="line">    </span><br><span class="line">    BOOL OK = [migrationManager progressivelyMigrateURL:[self sourceStoreURL]</span><br><span class="line">                                                 ofType:[self sourceStoreType]</span><br><span class="line">                                                toModel:[self managedObjectModel]</span><br><span class="line">                                                  error:error];</span><br><span class="line">    if (OK) &#123;</span><br><span class="line">        NSLog(@&quot;migration complete&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [[UIApplication sharedApplication] endBackgroundTask:bgTask];</span><br><span class="line">    bgTask = UIBackgroundTaskInvalid;</span><br><span class="line">    return OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单来说，需要递归进行版本<code>v</code>和版本<code>v+1</code>之间的数据迁移。具体包括：<br>1、检查当前数据版本与模型版本的兼容性<br>2、查找与当前数据版本v兼容的模型版本v，以及从该模型版本v到下一模型版本v+1的映射模型mapping model，这是自动查找的<br>3、是否有指定的mapping model<br>4、构建NSMigrationManager，执行迁移<br>5、数据备份及继续递归迁移</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">// CoreDataMigrationManager.m</span><br><span class="line">- (BOOL)progressivelyMigrateURL:(NSURL *)sourceStoreURL</span><br><span class="line">                         ofType:(NSString *)type</span><br><span class="line">                        toModel:(NSManagedObjectModel *)finalModel</span><br><span class="line">                          error:(NSError **)error</span><br><span class="line">&#123;</span><br><span class="line">    NSDictionary *sourceMetadata = [NSPersistentStoreCoordinator metadataForPersistentStoreOfType:type</span><br><span class="line">    URL:sourceStoreURL</span><br><span class="line">    error:error];</span><br><span class="line"></span><br><span class="line">    if (!sourceMetadata) &#123;</span><br><span class="line">        return NO;</span><br><span class="line">    &#125;</span><br><span class="line">    // 1、检查数据与模型版本兼容性</span><br><span class="line">    if ([finalModel isConfiguration:nil</span><br><span class="line">        compatibleWithStoreMetadata:sourceMetadata]) &#123;</span><br><span class="line">        if (NULL != error) &#123;</span><br><span class="line">            *error = nil;</span><br><span class="line">        &#125;</span><br><span class="line">        return YES;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 2、查找数据版本v对应的模型版本v、下一模型版本v+1、映射模型mapping model</span><br><span class="line">    NSManagedObjectModel *sourceModel = [self sourceModelForSourceMetadata:sourceMetadata];</span><br><span class="line">    NSManagedObjectModel *destinationModel = nil;</span><br><span class="line">    NSMappingModel *mappingModel = nil;</span><br><span class="line">    NSString *modelName = nil;</span><br><span class="line">    if (![self getDestinationModel:&amp;destinationModel</span><br><span class="line">                      mappingModel:&amp;mappingModel</span><br><span class="line">                         modelName:&amp;modelName</span><br><span class="line">                    forSourceModel:sourceModel</span><br><span class="line">                             error:error]) &#123;</span><br><span class="line">        return NO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 3、指定的mapping model</span><br><span class="line">    NSArray *mappingModels = @[mappingModel];</span><br><span class="line">    if ([self.delegate respondsToSelector:@selector(migrationManager:mappingModelsForSourceModel:)]) &#123;</span><br><span class="line">        NSArray *explicitMappingModels = [self.delegate migrationManager:self mappingModelsForSourceModel:sourceModel];</span><br><span class="line">        if (0 &lt; explicitMappingModels.count) &#123;</span><br><span class="line">            mappingModels = explicitMappingModels;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 4、迁移</span><br><span class="line">    NSURL *destinationStoreURL = [self destinationStoreURLWithSourceStoreURL:sourceStoreURL</span><br><span class="line">                                                                   modelName:modelName];</span><br><span class="line">    NSMigrationManager *manager = [[NSMigrationManager alloc] initWithSourceModel:sourceModel</span><br><span class="line">                                                                 destinationModel:destinationModel];</span><br><span class="line">    [manager addObserver:self</span><br><span class="line">              forKeyPath:@&quot;migrationProgress&quot;</span><br><span class="line">                 options:NSKeyValueObservingOptionNew</span><br><span class="line">                 context:nil];</span><br><span class="line">    BOOL didMigrate = NO;</span><br><span class="line">    for (NSMappingModel *mappingModel in mappingModels) &#123;</span><br><span class="line">        didMigrate = [manager migrateStoreFromURL:sourceStoreURL</span><br><span class="line">                                             type:type</span><br><span class="line">                                          options:nil</span><br><span class="line">                                 withMappingModel:mappingModel</span><br><span class="line">                                 toDestinationURL:destinationStoreURL</span><br><span class="line">                                  destinationType:type</span><br><span class="line">                               destinationOptions:nil</span><br><span class="line">                                            error:error];</span><br><span class="line">    &#125;</span><br><span class="line">    [manager removeObserver:self</span><br><span class="line">                 forKeyPath:@&quot;migrationProgress&quot;];</span><br><span class="line">    if (!didMigrate) &#123;</span><br><span class="line">        return NO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 数据备份及继续递归迁移</span><br><span class="line">    if (![self backupSourceStoreAtURL:sourceStoreURL</span><br><span class="line">          movingDestinationStoreAtURL:destinationStoreURL</span><br><span class="line">                                error:error]) &#123;</span><br><span class="line">        return NO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return [self progressivelyMigrateURL:sourceStoreURL</span><br><span class="line">                                  ofType:type</span><br><span class="line">                                 toModel:finalModel</span><br><span class="line">                                   error:error];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>// 注：参考Martin Hwasser的代码，具体可见<a href="https://github.com/objcio/issue-4-core-data-migration" target="_blank" rel="noopener">代码仓库</a>。</p>
<h5 id="迁移策略"><a href="#迁移策略" class="headerlink" title="迁移策略"></a>迁移策略</h5><p>对于更复杂的迁移，比如需要在实体之间新建关系等，则需要定制迁移策略了。定制迁移策略可以继承<code>NSEntityMigrationPolicy</code>，并重载<code>-createDestinationInstancesForSourceInstance:entityMapping:manager:error:</code>方法。</p>
<p>就如同<code>Model</code>与<code>Entity</code>的关系，<code>NSMappingModel</code>中包含了多个<code>NSEntityMapping</code>，<code>NSEntityMapping</code>是具体的实体映射的描述。<code>NSEntityMapping</code>在Xcode面板中可以配置User Info，这里可以做一些自定义的标识定义。</p>
<p>方法<code>-createDestinationInstancesForSourceInstance:entityMapping:manager:error:</code>中，我们可以根据需要创建实体的实例以及手动构建关系：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)createDestinationInstancesForSourceInstance:(NSManagedObject *)sourceInstance</span><br><span class="line">                                      entityMapping:(NSEntityMapping *)mapping</span><br><span class="line">                                            manager:(NSMigrationManager *)manager</span><br><span class="line">                                              error:(NSError *__autoreleasing *)error</span><br><span class="line">&#123;</span><br><span class="line">    NSNumber *modelVersion = [mapping.userInfo valueForKey:@&quot;modelVersion&quot;];</span><br><span class="line">    if (modelVersion.integerValue == 2 || modelVersion.integerValue == 3) &#123;</span><br><span class="line"></span><br><span class="line">        NSMutableArray *sourceKeys = [sourceInstance.entity.attributesByName.allKeys mutableCopy];</span><br><span class="line">        NSDictionary *sourceValues = [sourceInstance dictionaryWithValuesForKeys:sourceKeys];</span><br><span class="line"></span><br><span class="line">        NSManagedObject *destinationInstance = [NSEntityDescription insertNewObjectForEntityForName:[mapping destinationEntityName]</span><br><span class="line">                                                                             inManagedObjectContext:[manager destinationContext]];</span><br><span class="line">        NSArray *destinationKeys = destinationInstance.entity.attributesByName.allKeys;</span><br><span class="line"></span><br><span class="line">        for (NSString *key in destinationKeys) &#123;</span><br><span class="line">            id value = [sourceValues valueForKey:key];</span><br><span class="line">            // Avoid NULL values</span><br><span class="line">            if (value &amp;&amp; ![value isEqual:[NSNull null]]) &#123;</span><br><span class="line">                [destinationInstance setValue:value forKey:key];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (modelVersion.integerValue == 2) &#123;</span><br><span class="line">            // Check if we&apos;ve already created the authors lookup</span><br><span class="line">            NSMutableDictionary *authorLookup = [manager lookupWithKey:@&quot;authors&quot;];</span><br><span class="line">            // Check if we&apos;ve already created this author</span><br><span class="line">            NSString *authorName = [sourceInstance valueForKey:@&quot;authorName&quot;];</span><br><span class="line">            NSManagedObject *author = [authorLookup valueForKey:authorName];</span><br><span class="line">            if (!author) &#123;</span><br><span class="line">                // Create the author</span><br><span class="line">                author = [NSEntityDescription insertNewObjectForEntityForName:@&quot;Author&quot;</span><br><span class="line">                                                       inManagedObjectContext:[manager destinationContext]];</span><br><span class="line"></span><br><span class="line">                [author setValue:authorName forKey:@&quot;name&quot;];</span><br><span class="line"></span><br><span class="line">                // Populate lookup for reuse</span><br><span class="line">                [authorLookup setValue:author forKey:authorName];</span><br><span class="line">            &#125;</span><br><span class="line">            [destinationInstance performSelector:@selector(addAuthorsObject:) withObject:author];</span><br><span class="line">        &#125; else if (modelVersion.integerValue == 3) &#123;</span><br><span class="line">            NSArray *sourceUsers = [sourceInstance valueForKey:@&quot;users&quot;];</span><br><span class="line">            for (NSManagedObject *sourceUser in sourceUsers) &#123;</span><br><span class="line"></span><br><span class="line">                NSManagedObject *file = [NSEntityDescription insertNewObjectForEntityForName:@&quot;File&quot;</span><br><span class="line">                                                                      inManagedObjectContext:manager.destinationContext];</span><br><span class="line">                [file setValue:[sourceInstance valueForKey:@&quot;fileURL&quot;] forKey:@&quot;fileURL&quot;];</span><br><span class="line">                [file setValue:destinationInstance forKey:@&quot;book&quot;];</span><br><span class="line">                </span><br><span class="line">                NSInteger userId = [[sourceUser valueForKey:@&quot;userId&quot;] integerValue];</span><br><span class="line">                NSFetchRequest *request = [NSFetchRequest fetchRequestWithEntityName:@&quot;User&quot;];</span><br><span class="line">                request.predicate = [NSPredicate predicateWithFormat:@&quot;userId = %d&quot;, userId];</span><br><span class="line">                NSManagedObject *destinationUser = [[manager.destinationContext executeFetchRequest:request error:nil] lastObject];</span><br><span class="line">                [file setValue:destinationUser forKey:@&quot;user&quot;];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /// 告知迁移管理器，建立关联</span><br><span class="line">        [manager associateSourceInstance:sourceInstance</span><br><span class="line">                 withDestinationInstance:destinationInstance</span><br><span class="line">                        forEntityMapping:mapping];</span><br><span class="line"></span><br><span class="line">        return YES;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return [super createDestinationInstancesForSourceInstance:sourceInstance</span><br><span class="line">                                                    entityMapping:mapping</span><br><span class="line">                                                          manager:manager</span><br><span class="line">                                                            error:error];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于需要建立关系的迁移策略而言，还需要考虑实体迁移的顺序，否则在建立关系时，对应的实体还未迁移无法建立关系。实体迁移的顺序其实就是MappingModel中的EntityMapping的次序，按需修改便可。</p>
<p>从上面的流程可以看到，<code>Core Data</code>自定义数据迁移实际还是比较复杂的过程。希望客户端完善、好用的关系数据库ORM能早日出现。</p>
<p>参考资料：</p>
<p>1、<a href="http://osdir.com/ml/general/2013-06/msg34547.html" target="_blank" rel="noopener">http://osdir.com/ml/general/2013-06/msg34547.html</a></p>

    </div>
    
    <div class="post__license">
        <p>
            <strong>本文作者：</strong>Jason
        </p>
        <p>
            <strong>
                本文链接：
            </strong>
            <a href="http://blog.knpc21.com/ios/core-data-versioning/">http://blog.knpc21.com/ios/core-data-versioning/</a>
        </p>
        
            <strong>
                <p>文章默认使用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0</a> 协议进行许可，使用时请注意遵守协议。</p>

            </strong>
        
    </div>
 
    <div class="post-footer__meta"><p>更新于 2016-08-08</p></div> 
    <div class="post-entry__tags"><a href="/tags/iOS/" class="post-tags__link button"># iOS</a><a href="/tags/CoreData/" class="post-tags__link button"># CoreData</a></div> 
</article>


    <div class="nav">
        <div class="nav__prev">
            
                <a href="/ios/ios-animation-mediatiming/" class="nav__link">
                    <div>
                        <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="24" height="24"><path d="M589.088 790.624L310.464 512l278.624-278.624 45.248 45.248L400.96 512l233.376 233.376z" fill="#808080"></path></svg>
                    </div>
                    <div>
                        <div class="nav__label">
                            Previous Post
                        </div>
                        <div class="nav__title">
                            iOS开发：CAMediaTiming与动画
                        </div>
                    </div>
                </a>
            
        </div>
        <div class="nav__next">
            
                <a href="/ios/translated-gcd-in-depth-i/" class="nav__link">
                    <div>
                        <div class="nav__label">
                            Next Post
                        </div>
                        <div class="nav__title">
                            GCD in depth（GCD深入理解）
                        </div>
                    </div>
                    <div>
                        <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="24" height="24"><path d="M434.944 790.624l-45.248-45.248L623.04 512l-233.376-233.376 45.248-45.248L713.568 512z" fill="#808080"></path></svg>
                    </div>
                </a>
            
        </div>
    </div>



    <div class="post__comments content-card" id="comment">
        
    <h4>评论</h4>
    
    
    
    
    
    
    
    
    
    
    <div class="wildfire_thread"></div>

    


    </div>



</main>

            <footer class="footer">
     
    <a href="#" class="button" id="b2t" aria-label="回到顶部" title="回到顶部">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" width="32" height="32">
            <path d="M233.376 722.752L278.624 768 512 534.624 745.376 768l45.248-45.248L512 444.128zM192 352h640V288H192z" fill="currentColor"></path>
        </svg>
    </a>

    


    
     
 

 
    
    
</footer>

        </div>
         

 


    <script async src="https://www.googletagmanager.com/gtag/js?id=GTM-K2Q2J84"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'GTM-K2Q2J84');
    </script>
 

 

 


    <script defer src='https://static.cloudflareinsights.com/beacon.min.js'
        data-cf-beacon='{"token": "1d741b4fcb7f4062933be3f4b0eb6571"}'></script>
    </script>
    

 



 


    
 


    <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.4.1/dist/jquery.fancybox.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.4.1/dist/jquery.fancybox.min.js"></script>
    <script>
        let lazyloadT = Boolean('false'),
            auto_fancybox = Boolean('false')
        if (auto_fancybox) {
            $(".post__content").find('img').each(function () {
                var element = document.createElement("a");
                $(element).attr("data-fancybox", "gallery");
                $(element).attr("href", $(this).attr("src"));
                if (lazyloadT) {
                    $(element).attr("href", $(this).attr("data-srcset"));
                }
                $(this).wrap(element);
            });
        } else {
            $(".post__content").find("fancybox").find('img').each(function () {
                var element = document.createElement("a");
                $(element).attr("data-fancybox", "gallery");
                $(element).attr("href", $(this).attr("src"));
                if (lazyloadT) {
                    $(element).attr("href", $(this).attr("data-srcset"));
                }
                $(this).wrap(element);
            });
        }
    </script>
 

 

 

 

 


    

    
    
    

    
    
    
    
    

    
    
    
    
    

    
    
    



    </body>
</html>
